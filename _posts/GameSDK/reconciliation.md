

# 对账系统


### 简介

很多人在平时都会查看自己的网上银行、支付宝、微信等账户的账单，看看自己账户的收支情况与实际消费是否一致。这就是一个简单的对账过程。

对账系统是游戏SDK中非常重要的一部分，是保证资金安全的最后一道防线。


对账系统通常需要处理以下几个方面：

1. **交易记录的收集**：收集游戏内所有交易记录，包括购买、充值、消费等。
2. **账务数据的核对**：将收集到的交易记录与游戏内的账务数据进行核对，确保账务数据的准确性。
3. **异常交易的排查**：对账过程中发现异常交易，需要进行排查和处理。
4. **账务调整**：对账过程中发现账务不一致，需要进行调整。



### 对账架构设计

**要解决对账问题需要理清订单和资金的流转过程。**





## 实现


### 渠道对账



#### 数据来源
FTP
API
手动上传



#### 格式
CSV/JSON/Excel/XML



#### 对账规则

金额
货币
日期
商品ID
支付状态

#### 对账结果



Matching  完全匹配的。只记录一条匹配数据

```
transaction id,amount,currecny,date
TR-47884222201,140.00,USD,2020-01-20
TR-47884222203,5000.000,RMB,2020-01-25
TR-47884222206,500.00,USD,2020-02-10
```


对账的过程中可能会有存疑数据，这部分数据需要根据配置的存疑时间判断是否需要继续核对，如果没有过存疑时间，则继续核对，如果超过存疑时间且依旧异常的则会
落入  Mismatching 中。


Mismatching   在 Target 和 Source 数据中都存在的，但是金额、货币、商品ID、状态、日期等其中一项不匹配的 

```
type,transaction id,amount,currecny,date
SOURCE,TR-47884222202,20.000,USD,2020-01-22
TARGET,TR-47884222202,30.000,USD,2020-01-22
SOURCE,TR-47884222205,60.000,USD,2020-02-02
TARGET,TR-47884222205,60.000,USD,2020-02-03
```

Missing  在 Target 或 Source 数据中存在，但是在另一方数据中不存在

```
type,transaction id,amount,currency,date
SOURCE,TR-47884222204,1200.000,JOD,2020-01-31
TARGET,TR-47884222217,12000.000,JOD,2020-02-14
TARGET,TR-47884222245,420.00,USD,2020-01-12
```



#### 对账任务管理

在实际的对账过程中可能会有渠道的数据延迟、网络不通问题等，这就需要对账任务管理来保证对账的顺利进行，比如重试、失败记录等。
任务失败需要告警，并且能够人工介入发起重试。

#### 异常处理

**告警**
邮件、短信、工作沟通软件都可以，比如我们使用 Slack，一般会把告警信息发送到指定的频道。

**熔断**
单笔、账户、单个游戏、单个渠道、整个系统。
熔断的策略，比如单笔失败超过10次，则该笔数据进入人工处理。

当然也需要解熔断策略，比如单笔失败次数从10次降到5次，则恢复正常处理。


对于熔断的策略，要实现规则或者策略可配置化，让业务可以根据业务情况自行配置。这样当业务有变更时，只需要修改规则就可以了，不需要系统做更新、发布等。



### 银存对账




### 离线对账



### 实时对账



### 灵活
 Groovy 脚本

### 高并发

